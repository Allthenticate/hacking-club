import hashlib
import sqlite3 as sql

from flask import session


def insertUser(username, password):
    password = hashlib.md5(password.encode()).hexdigest()
    con = sql.connect("database.db")
    cur = con.cursor()
    cur.execute("SELECT username, password FROM users WHERE username = ?", (username,))
    users = cur.fetchall()
    if len(users) > 0:
        return
    cur.execute(
        "INSERT INTO users (username,password) VALUES (?,?)", (username, password)
    )
    con.commit()
    con.close()


def retrieveUsers():
    con = sql.connect("database.db")
    cur = con.cursor()
    cur.execute("SELECT username, password FROM users")
    users = cur.fetchall()
    con.close()
    return users


def searchUsers(username):
    con = sql.connect("database.db")
    cur = con.cursor()

    query = f"SELECT username FROM users WHERE username like '%{username}%'"
    print(query)
    cur.execute(query)
    users = cur.fetchall()
    con.close()
    return users


def loginUser(username, password) -> bool:
    con = sql.connect("database.db")
    cur = con.cursor()
    password = hashlib.md5(password.encode()).hexdigest()

    query = f"SELECT password FROM users WHERE username = ? AND password = ?"
    print(query)
    cur.execute(query, (username, password))
    users = cur.fetchall()
    con.close()

    if len(users) > 0:
        session['loggedin'] = username
        return True
    else:
        return False

def post_message(message) -> bool:
    if "loggedin" not in session:
        return False

    username = session['loggedin']

    con = sql.connect("database.db")
    cur = con.cursor()

    cur.execute(
        "INSERT INTO messages (username,message) VALUES (?,?)", (username, message)
    )
    con.commit()
    con.close()

    return True

def get_messages() -> bool:
    if "loggedin" not in session:
        return False

    username = session['loggedin']

    con = sql.connect("database.db")
    cur = con.cursor()
    query = f"SELECT message FROM messages WHERE username = ?"
    print(query)
    cur.execute(query, (username,))
    messages = cur.fetchall()
    con.close()

    return messages
