from flask import Flask
from flask import render_template
from flask import request
import models as dbHandler

app = Flask(__name__)
app.secret_key = 'shhhh its a secret'


@app.route("/", methods=["POST", "GET"])
def home():
    if request.method == "POST":
        username = request.form["username"]
        password = request.form["password"]
        dbHandler.insertUser(username, password)
        users = dbHandler.retrieveUsers()
        return render_template("index.html")
    else:
        return render_template("index.html")


@app.route("/login", methods=["POST"])
def login():
    username = request.form["username"]
    password = request.form["password"]
    try:
        if dbHandler.loginUser(username, password):
            messages = dbHandler.get_messages()
            return render_template("messages.html", messages=messages)
        else:
            return "I don't know you, get out of here."
    except Exception as e:
        return str(e)

@app.route("/search", methods=["GET"])
def search():
    username = request.args.get("username")
    try:
        users = dbHandler.searchUsers(username)
        return f"found {users}"

    except Exception as e:
        return str(e)


@app.route("/messages", methods=["POST","GET"])
def messages():
    if request.method == "POST":
        message = request.form["message"]
        dbHandler.post_message(message)

    messages = dbHandler.get_messages()
    return render_template("messages.html", messages=messages)


if __name__ == "__main__":
    app.run(debug=False, host="0.0.0.0", port=1337)
